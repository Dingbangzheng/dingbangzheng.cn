<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBZ GAME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0F172A',
                        secondary: '#3B82F6',
                        accent: '#10B981',
                        dark: '#030712',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        display: ['Rajdhani', 'sans-serif']
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            .text-glow {
                text-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
            }
            .bg-grid {
                background-image: linear-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px),
                                linear-gradient(90deg, rgba(59, 130, 246, 0.1) 1px, transparent 1px);
                background-size: 20px 20px;
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            .animate-pulse-slow {
                animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .tap-indicator {
                position: absolute;
                width: 40px;
                height: 40px;
                border: 2px solid rgba(255,255,255,0.5);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                pointer-events: none;
                z-index: 20;
                animation: tapEffect 0.6s ease-out forwards;
            }
            @keyframes float {
                0%, 100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-10px);
                }
            }
            @keyframes tapEffect {
                0% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(0.5);
                }
                100% {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(1.5);
                }
            }
        }
    </style>
    
    <!-- 引入字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-primary text-light overflow-hidden font-sans select-none">
    <!-- 游戏容器 -->
    <div id="game-container" class="relative w-full h-screen flex flex-col">
        <!-- 开始界面 -->
        <div id="start-screen" class="absolute inset-0 z-30 flex flex-col items-center justify-center bg-primary bg-grid transition-opacity duration-1000">
            <div class="text-center max-w-md px-6">
                <h1 class="text-[clamp(2.5rem,8vw,5rem)] font-display font-bold text-white text-glow mb-6 tracking-tight">
                    星际射手
                </h1>
                <p class="text-gray-300 text-lg mb-10 leading-relaxed">
                    抵御外星入侵，保卫空间站。点击屏幕任意位置进行瞄准和射击！
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center mb-6">
                    <button id="start-btn" class="bg-secondary hover:bg-secondary/80 text-white font-semibold py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-secondary/50">
                        <i class="fa fa-play mr-2"></i>普通模式
                    </button>
                    <button id="hard-mode-btn" class="bg-red-600 hover:bg-red-500 text-white font-semibold py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fa fa-bolt mr-2"></i>困难模式
                    </button>
                </div>
                <button id="instructions-btn" class="bg-transparent border border-gray-400 hover:border-white text-white font-semibold py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 mb-10">
                    <i class="fa fa-info-circle mr-2"></i>游戏说明
                </button>
                <div class="text-gray-400 text-sm animate-pulse-slow">
                    <i class="fa fa-rocket mr-1"></i> 准备就绪...
                </div>
            </div>
        </div>
        
        <!-- 游戏说明界面 -->
        <div id="instructions-screen" class="absolute inset-0 z-40 flex items-center justify-center bg-primary/95 backdrop-blur-sm hidden">
            <div class="bg-dark/80 rounded-xl p-8 max-w-md w-full mx-4 border border-gray-800 shadow-xl">
                <h2 class="text-2xl font-display font-bold mb-6 text-secondary">游戏说明</h2>
                <ul class="space-y-4 text-gray-300 mb-6">
                    <li class="flex items-start">
                        <i class="fa fa-mouse-pointer text-accent mt-1 mr-3"></i>
                        <span>点击屏幕任意位置控制瞄准方向并射击</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-hand-pointer-o text-accent mt-1 mr-3"></i>
                        <span>每次点击都会向点击位置发射子弹</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-shield text-accent mt-1 mr-3"></i>
                        <span>避免被敌人击中，你有3条生命</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-star text-accent mt-1 mr-3"></i>
                        <span>击中敌人获得分数，连续击中可获得连击加成</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-pause text-accent mt-1 mr-3"></i>
                        <span>按ESC键或点击暂停按钮暂停游戏</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                        <span><strong>困难模式：</strong>初始10发子弹，击败敌人可获得额外子弹</span>
                    </li>
                </ul>
                <button id="back-btn" class="w-full bg-secondary hover:bg-secondary/80 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300">
                    返回
                </button>
            </div>
        </div>
        
        <!-- 游戏画布 -->
        <canvas id="game-canvas" class="absolute inset-0 w-full h-full z-10"></canvas>
        
        <!-- 游戏UI -->
        <div id="game-ui" class="absolute inset-0 z-20 pointer-events-none opacity-0 transition-opacity duration-500">
            <!-- 顶部状态栏 -->
            <div class="flex justify-between items-center p-4">
                <div class="flex gap-6">
                    <!-- 分数显示 -->
                    <div class="flex items-center gap-2 bg-dark/50 backdrop-blur-sm px-4 py-2 rounded-lg border border-gray-800">
                        <i class="fa fa-trophy text-yellow-500 text-xl"></i>
                        <span id="score-display" class="font-display font-bold text-xl">0</span>
                    </div>
                    
                    <!-- 生命显示 -->
                    <div class="flex items-center gap-2 bg-dark/50 backdrop-blur-sm px-4 py-2 rounded-lg border border-gray-800">
                        <i class="fa fa-heart text-red-500 text-xl"></i>
                        <span id="lives-display" class="font-display font-bold text-xl">3</span>
                    </div>
                    
                    <!-- 子弹数量显示 (仅困难模式) -->
                    <div id="ammo-display-container" class="hidden flex items-center gap-2 bg-dark/50 backdrop-blur-sm px-4 py-2 rounded-lg border border-gray-800">
                        <i class="fa fa-crosshairs text-accent text-xl"></i>
                        <span id="ammo-display" class="font-display font-bold text-xl">10</span>
                    </div>
                </div>
                
                <!-- 暂停按钮 - 添加了更大的点击区域 -->
                <button id="pause-btn" class="bg-dark/50 backdrop-blur-sm hover:bg-dark/70 text-white p-4 rounded-full border border-gray-800 transition-all duration-300 pointer-events-auto">
                    <i class="fa fa-pause text-2xl"></i>
                </button>
            </div>
            
            <!-- 连击提示 -->
            <div id="combo-indicator" class="absolute top-1/3 left-1/2 transform -translate-x-1/2 text-3xl font-display font-bold text-accent opacity-0 transition-opacity duration-300 pointer-events-none">
                x3 连击!
            </div>
            
            <!-- 无子弹提示 (仅困难模式) -->
            <div id="no-ammo-indicator" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-display font-bold text-red-500 opacity-0 transition-opacity duration-300 pointer-events-none">
                没有子弹了!
            </div>
        </div>
        
        <!-- 暂停界面 -->
        <div id="pause-screen" class="absolute inset-0 z-30 flex flex-col items-center justify-center bg-primary/80 backdrop-blur-sm hidden">
            <div class="text-center bg-dark/90 p-8 rounded-xl border border-gray-800 shadow-2xl max-w-xs w-full mx-4">
                <h2 class="text-3xl font-display font-bold mb-6 text-white">游戏暂停</h2>
                <div class="flex flex-col gap-4 mb-6">
                    <button id="resume-btn" class="bg-secondary hover:bg-secondary/80 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300">
                        <i class="fa fa-play mr-2"></i>继续游戏
                    </button>
                    <button id="restart-btn" class="bg-transparent border border-gray-400 hover:border-white text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300">
                        <i class="fa fa-refresh mr-2"></i>重新开始
                    </button>
                </div>
                <button id="quit-btn" class="w-full bg-transparent border border-red-500 hover:bg-red-500/10 text-red-400 hover:text-red-300 font-semibold py-3 px-4 rounded-lg transition-all duration-300">
                    <i class="fa fa-sign-out mr-2"></i>退出游戏
                </button>
            </div>
        </div>
        
        <!-- 结束界面 -->
        <div id="game-over-screen" class="absolute inset-0 z-30 flex flex-col items-center justify-center bg-primary/90 backdrop-blur-sm hidden">
            <div class="text-center bg-dark/90 p-8 rounded-xl border border-gray-800 shadow-2xl max-w-md w-full mx-4 transform transition-all duration-500 scale-95 opacity-0" id="game-over-card">
                <h2 class="text-3xl font-display font-bold mb-2 text-red-400">游戏结束</h2>
                <p class="text-gray-400 mb-6">太空站已被摧毁</p>
                
                <div class="bg-gray-800/50 rounded-lg p-4 mb-6">
                    <p class="text-gray-400 text-sm mb-1">最终得分</p>
                    <p id="final-score" class="text-4xl font-display font-bold text-white">0</p>
                </div>
                
                <div class="flex flex-col gap-4">
                    <button id="play-again-btn" class="bg-secondary hover:bg-secondary/80 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fa fa-refresh mr-2"></i>再玩一次
                    </button>
                    <button id="back-to-menu-btn" class="bg-transparent border border-gray-400 hover:border-white text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300">
                        <i class="fa fa-home mr-2"></i>返回菜单
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 游戏主类
        class ShooterGame {
            constructor() {
                // 获取DOM元素
                this.canvas = document.getElementById('game-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.scoreDisplay = document.getElementById('score-display');
                this.livesDisplay = document.getElementById('lives-display');
                this.comboIndicator = document.getElementById('combo-indicator');
                this.ammoDisplay = document.getElementById('ammo-display');
                this.ammoDisplayContainer = document.getElementById('ammo-display-container');
                this.noAmmoIndicator = document.getElementById('no-ammo-indicator');
                
                // 游戏界面
                this.startScreen = document.getElementById('start-screen');
                this.instructionsScreen = document.getElementById('instructions-screen');
                this.gameUI = document.getElementById('game-ui');
                this.pauseScreen = document.getElementById('pause-screen');
                this.gameOverScreen = document.getElementById('game-over-screen');
                this.gameOverCard = document.getElementById('game-over-card');
                this.gameContainer = document.getElementById('game-container');
                
                // 按钮
                this.startBtn = document.getElementById('start-btn');
                this.hardModeBtn = document.getElementById('hard-mode-btn');
                this.instructionsBtn = document.getElementById('instructions-btn');
                this.backBtn = document.getElementById('back-btn');
                this.pauseBtn = document.getElementById('pause-btn');
                this.resumeBtn = document.getElementById('resume-btn');
                this.restartBtn = document.getElementById('restart-btn');
                this.quitBtn = document.getElementById('quit-btn');
                this.playAgainBtn = document.getElementById('play-again-btn');
                this.backToMenuBtn = document.getElementById('back-to-menu-btn');
                
                // 游戏状态
                this.isRunning = false;
                this.isPaused = false;
                this.isHardMode = false;
                this.score = 0;
                this.lives = 3;
                this.ammo = 0; // 子弹数量
                this.combo = 0;
                this.lastHitTime = 0;
                this.comboTimeout = 2000; // 2秒内连续击中才算连击
                
                // 鼠标/触摸位置
                this.inputX = 0;
                this.inputY = 0;
                
                // 游戏对象
                this.player = null;
                this.bullets = [];
                this.enemies = [];
                this.explosions = [];
                this.particles = [];
                this.stars = [];
                
                // 游戏循环
                this.lastTime = 0;
                this.enemySpawnTimer = 0;
                this.enemySpawnInterval = 1500; // 敌人生成间隔(毫秒)
                
                // 检测设备类型
                this.isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                // 绑定事件监听
                this.bindEvents();
                
                // 初始化画布尺寸
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // 初始化星空背景
                this.initStars();
            }
            
            // 初始化星空背景
            initStars() {
                this.stars = [];
                for (let i = 0; i < 100; i++) {
                    this.stars.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        radius: Math.random() * 1.5,
                        opacity: Math.random(),
                        speed: Math.random() * 0.5 + 0.1
                    });
                }
            }
            
            // 调整画布尺寸
            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                // 如果游戏正在运行，更新玩家位置
                if (this.player) {
                    this.player.x = this.canvas.width / 2;
                    this.player.y = this.canvas.height / 2;
                }
            }
            
            // 绑定事件监听
            bindEvents() {
                // 鼠标移动 - 瞄准（仅桌面设备）
                window.addEventListener('mousemove', (e) => {
                    if (!this.isMobile) { // 非移动设备才响应鼠标移动
                        this.inputX = e.clientX;
                        this.inputY = e.clientY;
                    }
                });
                
                // 鼠标点击 - 射击
                window.addEventListener('click', (e) => {
                    // 检查是否点击了UI元素
                    if (e.target.closest('#game-ui, #pause-screen, #game-over-screen, #start-screen, #instructions-screen')) {
                        return; // 点击了UI元素，不进行射击
                    }
                    
                    if (this.isRunning && !this.isPaused) {
                        // 更新瞄准位置
                        this.inputX = e.clientX;
                        this.inputY = e.clientY;
                        
                        // 射击
                        this.shoot();
                        
                        // 添加点击效果（仅桌面）
                        if (!this.isMobile) {
                            this.createTapEffect(e.clientX, e.clientY);
                        }
                    }
                });
                
                // 触屏点击 - 瞄准和射击
                window.addEventListener('touchstart', (e) => {
                    // 检查是否触摸了UI元素
                    const touch = e.touches[0];
                    const element = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (element && element.closest('#game-ui, #pause-screen, #game-over-screen, #start-screen, #instructions-screen')) {
                        return; // 触摸了UI元素，不进行射击
                    }
                    
                    if (this.isRunning && !this.isPaused) {
                        e.preventDefault();
                        
                        // 获取触摸位置
                        this.inputX = touch.clientX;
                        this.inputY = touch.clientY;
                        
                        // 射击
                        this.shoot();
                        
                        // 添加点击效果
                        this.createTapEffect(touch.clientX, touch.clientY);
                    }
                }, { passive: false });
                
                // 触屏移动 - 更新瞄准位置（不射击）
                window.addEventListener('touchmove', (e) => {
                    // 检查是否触摸了UI元素
                    const touch = e.touches[0];
                    const element = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (element && element.closest('#game-ui, #pause-screen, #game-over-screen, #start-screen, #instructions-screen')) {
                        return; // 触摸了UI元素，不更新瞄准
                    }
                    
                    if (this.isRunning && !this.isPaused) {
                        const touch = e.touches[0];
                        this.inputX = touch.clientX;
                        this.inputY = touch.clientY;
                    }
                }, { passive: true });
                
                // 键盘事件 - ESC暂停
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isRunning) {
                        if (this.isPaused) {
                            this.resumeGame();
                        } else {
                            this.pauseGame();
                        }
                    }
                });
                
                // 按钮事件 - 确保暂停按钮事件正确绑定
                this.pauseBtn.addEventListener('click', () => this.pauseGame());
                this.pauseBtn.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    this.pauseGame();
                }, { passive: false });
                
                this.startBtn.addEventListener('click', () => this.startGame(false));
                this.hardModeBtn.addEventListener('click', () => this.startGame(true));
                this.instructionsBtn.addEventListener('click', () => this.showInstructions());
                this.backBtn.addEventListener('click', () => this.hideInstructions());
                this.resumeBtn.addEventListener('click', () => this.resumeGame());
                this.restartBtn.addEventListener('click', () => this.restartGame());
                this.quitBtn.addEventListener('click', () => this.quitGame());
                this.playAgainBtn.addEventListener('click', () => this.restartGame());
                this.backToMenuBtn.addEventListener('click', () => this.quitGame());
                
                // 防止触摸设备上的默认行为，但允许UI元素正常工作
                document.addEventListener('touchstart', (e) => {
                    // 检查是否触摸了游戏画布
                    if (e.target === this.canvas && this.isRunning && !this.isPaused) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                document.addEventListener('touchmove', (e) => {
                    if (e.target === this.canvas && this.isRunning && !this.isPaused) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            
            // 创建点击效果
            createTapEffect(x, y) {
                // 创建点击视觉反馈元素
                const tapIndicator = document.createElement('div');
                tapIndicator.classList.add('tap-indicator');
                tapIndicator.style.left = `${x}px`;
                tapIndicator.style.top = `${y}px`;
                this.gameContainer.appendChild(tapIndicator);
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (tapIndicator.parentNode === this.gameContainer) {
                        this.gameContainer.removeChild(tapIndicator);
                    }
                }, 600);
            }
            
            // 显示游戏说明
            showInstructions() {
                this.startScreen.classList.add('hidden');
                this.instructionsScreen.classList.remove('hidden');
            }
            
            // 隐藏游戏说明
            hideInstructions() {
                this.instructionsScreen.classList.add('hidden');
                this.startScreen.classList.remove('hidden');
            }
            
            // 开始游戏
            startGame(isHardMode) {
                // 设置游戏模式
                this.isHardMode = isHardMode;
                
                // 重置游戏状态
                this.score = 0;
                this.lives = 3;
                this.combo = 0;
                this.bullets = [];
                this.enemies = [];
                this.explosions = [];
                this.particles = [];
                
                // 初始化子弹数量（困难模式有数量限制）
                if (this.isHardMode) {
                    this.ammo = 10; // 修改初始子弹数量为10
                    this.ammoDisplay.textContent = this.ammo;
                    this.ammoDisplayContainer.classList.remove('hidden');
                } else {
                    this.ammo = Infinity; // 无限子弹
                    this.ammoDisplayContainer.classList.add('hidden');
                }
                
                // 更新显示
                this.scoreDisplay.textContent = this.score;
                this.livesDisplay.textContent = this.lives;
                
                // 初始化输入位置为屏幕中心
                this.inputX = this.canvas.width / 2;
                this.inputY = this.canvas.height / 2;
                
                // 创建玩家
                this.player = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height / 2,
                    radius: 15,
                    color: '#3B82F6',
                    speed: 5,
                    angle: 0
                };
                
                // 隐藏开始界面，显示游戏UI
                this.startScreen.classList.add('opacity-0');
                setTimeout(() => {
                    this.startScreen.classList.add('hidden');
                    this.gameUI.classList.remove('opacity-0');
                }, 1000);
                
                // 开始游戏循环
                this.isRunning = true;
                this.isPaused = false;
                requestAnimationFrame((timestamp) => this.gameLoop(timestamp));
            }
            
            // 暂停游戏
            pauseGame() {
                if (!this.isRunning || this.isPaused) return;
                
                this.isPaused = true;
                this.pauseScreen.classList.remove('hidden');
            }
            
            // 恢复游戏
            resumeGame() {
                if (!this.isRunning || !this.isPaused) return;
                
                this.isPaused = false;
                this.pauseScreen.classList.add('hidden');
                this.lastTime = performance.now();
                requestAnimationFrame((timestamp) => this.gameLoop(timestamp));
            }
            
            // 重新开始游戏
            restartGame() {
                // 隐藏暂停或结束界面
                this.pauseScreen.classList.add('hidden');
                this.gameOverScreen.classList.add('hidden');
                
                // 重新开始
                this.startGame(this.isHardMode);
            }
            
            // 退出游戏
            quitGame() {
                // 停止游戏
                this.isRunning = false;
                this.isPaused = false;
                
                // 隐藏游戏UI和暂停/结束界面
                this.gameUI.classList.add('opacity-0');
                this.pauseScreen.classList.add('hidden');
                this.gameOverScreen.classList.add('hidden');
                
                // 显示开始界面
                setTimeout(() => {
                    this.startScreen.classList.remove('hidden', 'opacity-0');
                }, 500);
            }
            
            // 游戏结束
            gameOver() {
                this.isRunning = false;
                
                // 更新最终得分
                document.getElementById('final-score').textContent = this.score;
                
                // 显示游戏结束界面
                setTimeout(() => {
                    this.gameOverScreen.classList.remove('hidden');
                    // 添加动画效果
                    setTimeout(() => {
                        this.gameOverCard.classList.remove('scale-95', 'opacity-0');
                        this.gameOverCard.classList.add('scale-100', 'opacity-100');
                    }, 100);
                }, 1000);
            }
            
            // 射击
            shoot() {
                // 困难模式下检查子弹数量
                if (this.isHardMode && this.ammo <= 0) {
                    // 显示无子弹提示
                    this.showNoAmmoIndicator();
                    return;
                }
                
                // 计算子弹方向
                const dx = this.inputX - this.player.x;
                const dy = this.inputY - this.player.y;
                const angle = Math.atan2(dy, dx);
                const speed = 10;
                
                // 创建子弹
                this.bullets.push({
                    x: this.player.x,
                    y: this.player.y,
                    radius: 4,
                    color: '#10B981',
                    speed: speed,
                    angle: angle,
                    life: 60 // 子弹生命周期(帧)
                });
                
                // 困难模式下减少子弹数量
                if (this.isHardMode) {
                    this.ammo--;
                    this.ammoDisplay.textContent = this.ammo;
                }
                
                // 播放射击粒子效果
                this.createMuzzleFlash();
            }
            
            // 显示无子弹提示
            showNoAmmoIndicator() {
                this.noAmmoIndicator.classList.remove('opacity-0');
                this.noAmmoIndicator.classList.add('opacity-100');
                
                // 1秒后隐藏
                clearTimeout(this.noAmmoTimeoutId);
                this.noAmmoTimeoutId = setTimeout(() => {
                    this.noAmmoIndicator.classList.remove('opacity-100');
                    this.noAmmoIndicator.classList.add('opacity-0');
                }, 1000);
            }
            
            // 创建枪口闪光效果
            createMuzzleFlash() {
                const angle = this.player.angle;
                const distance = this.player.radius + 5;
                
                // 计算闪光位置（枪口位置）
                const x = this.player.x + Math.cos(angle) * distance;
                const y = this.player.y + Math.sin(angle) * distance;
                
                // 创建闪光粒子
                for (let i = 0; i < 8; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        radius: Math.random() * 3 + 1,
                        color: `rgba(255, ${Math.random() * 100 + 155}, 0, 0.8)`,
                        speed: Math.random() * 3 + 1,
                        angle: angle + (Math.random() - 0.5) * 0.8,
                        life: Math.random() * 15 + 10,
                        decay: 0.9
                    });
                }
            }
            
            // 创建爆炸效果
            createExplosion(x, y, size = 1) {
                // 添加爆炸动画
                this.explosions.push({
                    x: x,
                    y: y,
                    radius: 5 * size,
                    maxRadius: 30 * size,
                    color: `rgba(255, ${Math.random() * 100 + 55}, 0, 1)`,
                    alpha: 1,
                    speed: 2 * size,
                    life: 30
                });
                
                // 创建爆炸粒子
                for (let i = 0; i < 20 * size; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        radius: Math.random() * 3 * size + 1,
                        color: `rgba(255, ${Math.random() * 100 + 55}, 0, ${Math.random() * 0.5 + 0.5})`,
                        speed: Math.random() * 5 * size + 1,
                        angle: Math.random() * Math.PI * 2,
                        life: Math.random() * 30 + 20,
                        decay: 0.95
                    });
                }
            }
            
            // 生成敌人
            spawnEnemy(deltaTime) {
                this.enemySpawnTimer += deltaTime;
                
                if (this.enemySpawnTimer >= this.enemySpawnInterval) {
                    this.enemySpawnTimer = 0;
                    
                    // 随时间减少生成间隔，增加难度
                    this.enemySpawnInterval = Math.max(500, this.enemySpawnInterval - 10);
                    
                    // 随机选择一个边缘位置生成敌人
                    let x, y;
                    const side = Math.floor(Math.random() * 4); // 0-3 代表四个方向
                    
                    switch (side) {
                        case 0: // 顶部
                            x = Math.random() * this.canvas.width;
                            y = -50;
                            break;
                        case 1: // 右侧
                            x = this.canvas.width + 50;
                            y = Math.random() * this.canvas.height;
                            break;
                        case 2: // 底部
                            x = Math.random() * this.canvas.width;
                            y = this.canvas.height + 50;
                            break;
                        case 3: // 左侧
                            x = -50;
                            y = Math.random() * this.canvas.height;
                            break;
                    }
                    
                    // 随机敌人类型
                    const enemyType = Math.random();
                    let radius, speed, color, health;
                    
                    if (enemyType < 0.7) {
                        // 普通敌人（小红）
                        radius = 12;
                        speed = 2;
                        color = '#EF4444';
                        health = 1;
                    } else if (enemyType < 0.9) {
                        // 快速敌人（黄色）
                        radius = 8;
                        speed = 4;
                        color = '#F59E0B';
                        health = 1;
                    } else {
                        // 大型敌人（大红）
                        radius = 20;
                        speed = 1;
                        color = '#7F1D1D';
                        health = 3;
                    }
                    
                    // 添加敌人
                    this.enemies.push({
                        x: x,
                        y: y,
                        radius: radius,
                        color: color,
                        speed: speed,
                        health: health,
                        maxHealth: health,
                        angle: 0
                    });
                }
            }
            
            // 更新游戏对象
            update(deltaTime) {
                // 更新玩家角度（面向鼠标/触摸位置）
                if (this.player) {
                    this.player.angle = Math.atan2(
                        this.inputY - this.player.y,
                        this.inputX - this.player.x
                    );
                }
                
                // 更新子弹
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    bullet.x += Math.cos(bullet.angle) * bullet.speed;
                    bullet.y += Math.sin(bullet.angle) * bullet.speed;
                    bullet.life--;
                    
                    // 移除超出屏幕或生命周期结束的子弹
                    if (bullet.life <= 0 || 
                        bullet.x < -bullet.radius || 
                        bullet.x > this.canvas.width + bullet.radius || 
                        bullet.y < -bullet.radius || 
                        bullet.y > this.canvas.height + bullet.radius) {
                        this.bullets.splice(i, 1);
                    }
                }
                
                // 更新敌人
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    
                    // 敌人面向玩家移动
                    if (this.player) {
                        enemy.angle = Math.atan2(
                            this.player.y - enemy.y,
                            this.player.x - enemy.x
                        );
                    }
                    
                    enemy.x += Math.cos(enemy.angle) * enemy.speed;
                    enemy.y += Math.sin(enemy.angle) * enemy.speed;
                    
                    // 检测敌人是否到达玩家位置（碰撞检测）
                    if (this.player) {
                        const dx = enemy.x - this.player.x;
                        const dy = enemy.y - this.player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < enemy.radius + this.player.radius) {
                            // 敌人与玩家碰撞
                            this.createExplosion(enemy.x, enemy.y, enemy.radius / 10);
                            this.enemies.splice(i, 1);
                            
                            // 减少生命值
                            this.lives--;
                            this.livesDisplay.textContent = this.lives;
                            
                            // 重置连击
                            this.combo = 0;
                            
                            // 检查游戏是否结束
                            if (this.lives <= 0) {
                                this.gameOver();
                                return;
                            }
                        }
                    }
                    
                    // 移除超出屏幕范围过大的敌人
                    if (enemy.x < -200 || enemy.x > this.canvas.width + 200 || 
                        enemy.y < -200 || enemy.y > this.canvas.height + 200) {
                        this.enemies.splice(i, 1);
                    }
                }
                
                // 更新爆炸效果
                for (let i = this.explosions.length - 1; i >= 0; i--) {
                    const explosion = this.explosions[i];
                    
                    explosion.radius += explosion.speed;
                    explosion.alpha -= 0.03;
                    explosion.life--;
                    
                    if (explosion.life <= 0) {
                        this.explosions.splice(i, 1);
                    }
                }
                
                // 更新粒子
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    
                    particle.x += Math.cos(particle.angle) * particle.speed;
                    particle.y += Math.sin(particle.angle) * particle.speed;
                    particle.speed *= particle.decay;
                    particle.life--;
                    
                    if (particle.life <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
                
                // 更新星星背景
                for (const star of this.stars) {
                    star.y += star.speed;
                    if (star.y > this.canvas.height) {
                        star.y = 0;
                        star.x = Math.random() * this.canvas.width;
                    }
                }
                
                // 检测子弹与敌人碰撞
                this.checkCollisions();
                
                // 生成敌人
                this.spawnEnemy(deltaTime);
                
                // 更新连击指示器
                this.updateComboIndicator();
            }
            
            // 检测碰撞
            checkCollisions() {
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    for (let j = this.enemies.length - 1; j >= 0; j--) {
                        const enemy = this.enemies[j];
                        
                        const dx = bullet.x - enemy.x;
                        const dy = bullet.y - enemy.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < bullet.radius + enemy.radius) {
                            // 子弹击中敌人
                            this.bullets.splice(i, 1);
                            
                            // 敌人受伤
                            enemy.health--;
                            
                            // 创建命中效果
                            this.createHitEffect(bullet.x, bullet.y);
                            
                            // 检查敌人是否被消灭
                            if (enemy.health <= 0) {
                                // 根据敌人类型计算得分和奖励子弹
                                let points = 100;
                                let ammoReward = 1; // 默认奖励1发子弹
                                
                                if (enemy.radius === 8) {
                                    points = 150; // 快速敌人（黄色）
                                    ammoReward = 6; // 奖励6发子弹
                                } else if (enemy.radius === 20) {
                                    points = 300; // 大型敌人（大红）
                                    ammoReward = 15; // 奖励15发子弹
                                } else {
                                    // 普通敌人（小红）
                                    ammoReward = 4; // 奖励4发子弹
                                }
                                
                                // 困难模式下增加子弹
                                if (this.isHardMode) {
                                    this.ammo += ammoReward;
                                    this.ammoDisplay.textContent = this.ammo;
                                }
                                
                                // 处理连击
                                const now = Date.now();
                                if (now - this.lastHitTime < this.comboTimeout && this.combo > 0) {
                                    this.combo++;
                                    points = Math.round(points * (1 + this.combo * 0.2));
                                    
                                    // 显示连击提示
                                    this.showComboIndicator();
                                } else {
                                    this.combo = 1;
                                }
                                this.lastHitTime = now;
                                
                                // 增加分数
                                this.score += points;
                                this.scoreDisplay.textContent = this.score;
                                
                                // 创建爆炸效果
                                this.createExplosion(enemy.x, enemy.y, enemy.radius / 10);
                                
                                // 移除敌人
                                this.enemies.splice(j, 1);
                            }
                            
                            break; // 一颗子弹只能击中一个敌人
                        }
                    }
                }
            }
            
            // 创建命中效果
            createHitEffect(x, y) {
                for (let i = 0; i < 5; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        radius: Math.random() * 2 + 1,
                        color: `rgba(16, 185, 129, ${Math.random() * 0.5 + 0.5})`,
                        speed: Math.random() * 3 + 1,
                        angle: Math.random() * Math.PI * 2,
                        life: Math.random() * 15 + 10,
                        decay: 0.9
                    });
                }
            }
            
            // 显示连击指示器
            showComboIndicator() {
                this.comboIndicator.textContent = `x${this.combo} 连击!`;
                this.comboIndicator.classList.remove('opacity-0');
                this.comboIndicator.classList.add('opacity-100');
                
                // 3秒后隐藏
                clearTimeout(this.comboTimeoutId);
                this.comboTimeoutId = setTimeout(() => {
                    this.comboIndicator.classList.remove('opacity-100');
                    this.comboIndicator.classList.add('opacity-0');
                }, 1000);
            }
            
            // 更新连击指示器
            updateComboIndicator() {
                if (this.combo > 0 && Date.now() - this.lastHitTime > this.comboTimeout) {
                    this.combo = 0;
                    this.comboIndicator.classList.remove('opacity-100');
                    this.comboIndicator.classList.add('opacity-0');
                }
            }
            
            // 绘制游戏对象
            render() {
                // 清空画布
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 绘制星空背景
                this.ctx.fillStyle = '#0F172A';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (const star of this.stars) {
                    this.ctx.beginPath();
                    this.ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    this.ctx.fill();
                }
                
                // 绘制粒子
                for (const particle of this.particles) {
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = particle.color;
                    this.ctx.fill();
                }
                
                // 绘制爆炸
                for (const explosion of this.explosions) {
                    this.ctx.beginPath();
                    this.ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = `rgba(255, 156, 0, ${explosion.alpha})`;
                    this.ctx.fill();
                    
                    // 爆炸波纹
                    this.ctx.beginPath();
                    this.ctx.arc(explosion.x, explosion.y, explosion.radius * 0.7, 0, Math.PI * 2);
                    this.ctx.fillStyle = `rgba(255, 99, 71, ${explosion.alpha * 0.7})`;
                    this.ctx.fill();
                }
                
                // 绘制子弹
                for (const bullet of this.bullets) {
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = bullet.color;
                    this.ctx.fill();
                    
                    // 子弹尾迹
                    const trailLength = 10;
                    const trailX = bullet.x - Math.cos(bullet.angle) * trailLength;
                    const trailY = bullet.y - Math.sin(bullet.angle) * trailLength;
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(bullet.x, bullet.y);
                    this.ctx.lineTo(trailX, trailY);
                    this.ctx.strokeStyle = `${bullet.color}80`; // 添加透明度
                    this.ctx.lineWidth = bullet.radius * 1.5;
                    this.ctx.stroke();
                }
                
                // 绘制敌人
                for (const enemy of this.enemies) {
                    // 敌人主体
                    this.ctx.beginPath();
                    this.ctx.arc(enemy.x, enemy.y, enemy.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = enemy.color;
                    this.ctx.fill();
                    
                    // 敌人边框
                    this.ctx.beginPath();
                    this.ctx.arc(enemy.x, enemy.y, enemy.radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                    
                    // 敌人朝向
                    this.ctx.save();
                    this.ctx.translate(enemy.x, enemy.y);
                    this.ctx.rotate(enemy.angle);
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, 0);
                    this.ctx.lineTo(enemy.radius, 0);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                    this.ctx.restore();
                    
                    // 生命值条（仅对有多个生命值的敌人）
                    if (enemy.maxHealth > 1) {
                        const healthBarWidth = enemy.radius * 2;
                        const healthBarHeight = 3;
                        const healthPercentage = enemy.health / enemy.maxHealth;
                        
                        // 背景
                        this.ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                        this.ctx.fillRect(
                            enemy.x - healthBarWidth / 2,
                            enemy.y - enemy.radius - 10,
                            healthBarWidth,
                            healthBarHeight
                        );
                        
                        // 前景
                        this.ctx.fillStyle = 'rgba(16, 185, 129, 0.8)';
                        this.ctx.fillRect(
                            enemy.x - healthBarWidth / 2,
                            enemy.y - enemy.radius - 10,
                            healthBarWidth * healthPercentage,
                            healthBarHeight
                        );
                    }
                }
                
                // 绘制玩家
                if (this.player) {
                    // 玩家主体
                    this.ctx.beginPath();
                    this.ctx.arc(this.player.x, this.player.y, this.player.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = this.player.color;
                    this.ctx.fill();
                    
                    // 玩家边框
                    this.ctx.beginPath();
                    this.ctx.arc(this.player.x, this.player.y, this.player.radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                    
                    // 玩家瞄准线
                    this.ctx.save();
                    this.ctx.translate(this.player.x, this.player.y);
                    this.ctx.rotate(this.player.angle);
                    
                    // 内部三角形
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.player.radius, 0);
                    this.ctx.lineTo(-this.player.radius * 0.7, -this.player.radius * 0.5);
                    this.ctx.lineTo(-this.player.radius * 0.7, this.player.radius * 0.5);
                    this.ctx.closePath();
                    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.fill();
                    
                    this.ctx.restore();
                    
                    // 玩家到瞄准点的指示线
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.player.x, this.player.y);
                    this.ctx.lineTo(this.inputX, this.inputY);
                    this.ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
                    this.ctx.lineWidth = 1;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                    
                    // 玩家护盾效果（呼吸动画）
                    const shieldPulse = 0.5 + Math.sin(Date.now() * 0.002) * 0.2;
                    this.ctx.beginPath();
                    this.ctx.arc(
                        this.player.x, 
                        this.player.y, 
                        this.player.radius + 5 + shieldPulse * 3, 
                        0, 
                        Math.PI * 2
                    );
                    this.ctx.strokeStyle = `rgba(59, 130, 246, ${0.2 + shieldPulse * 0.1})`;
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                }
                
                // 绘制瞄准点
                if (this.isRunning && !this.isPaused) {
                    this.ctx.beginPath();
                    this.ctx.arc(this.inputX, this.inputY, 10, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                    
                    this.ctx.beginPath();
                    this.ctx.arc(this.inputX, this.inputY, 15, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }
            }
            
            // 游戏主循环
            gameLoop(timestamp) {
                if (!this.isRunning || this.isPaused) return;
                
                // 计算时间差（毫秒）
                const deltaTime = timestamp - (this.lastTime || timestamp);
                this.lastTime = timestamp;
                
                // 更新游戏状态
                this.update(deltaTime);
                
                // 绘制游戏画面
                this.render();
                
                // 继续游戏循环
                requestAnimationFrame((timestamp) => this.gameLoop(timestamp));
            }
        }
        
        // 初始化游戏
        window.addEventListener('load', () => {
            const game = new ShooterGame();
        });
    </script>
</body>
</html>